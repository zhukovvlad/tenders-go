-- winner.sql
-- 
-- Этот файл содержит SQL-запросы для управления победителями тендеров.
-- Победители (winners) связаны с конкретными предложениями (proposals),
-- которые в свою очередь привязаны к лотам (lots) в рамках тендера.

-- ============================================================================
-- СОЗДАНИЕ И ОБНОВЛЕНИЕ
-- ============================================================================

-- name: UpsertWinner :one
-- Назначение: Создает или обновляет запись победителя (идемпотентная операция).
--             Используется при импорте данных или массовом обновлении.
-- 
-- Параметры:
--   $1 (proposal_id) - ID предложения, которое становится победителем
--   $2 (rank)        - Место победителя (1 = первое место, 2 = второе, и т.д.)
--   $3 (awarded_share) - Доля контракта, присужденная победителю (может быть NULL)
--   $4 (notes)       - Дополнительные заметки о победителе (может быть NULL)
-- 
-- Поведение:
--   - Если proposal_id уже существует в таблице winners, обновляет его данные
--   - Если proposal_id новый, создает новую запись
--   - Автоматически обновляет updated_at при конфликте
-- 
-- Возвращает: Полную запись победителя (все поля)
-- 
-- Использование: Импорт данных, синхронизация с внешними системами
INSERT INTO winners (
    proposal_id,
    rank,
    awarded_share,
    notes
) VALUES (
    $1, $2, $3, $4
)
ON CONFLICT (proposal_id) DO UPDATE SET
    rank = EXCLUDED.rank,
    awarded_share = EXCLUDED.awarded_share,
    notes = EXCLUDED.notes,
    updated_at = NOW()
RETURNING *;

-- name: CreateWinner :one
-- Назначение: Создает нового победителя (строгая проверка уникальности).
--             Используется в REST API для ручного назначения победителей.
-- 
-- Параметры:
--   $1 (proposal_id) - ID предложения, которое назначается победителем
--   $2 (rank)        - Место победителя (1, 2, 3, ...)
--   $3 (notes)       - Дополнительные заметки (может быть NULL)
-- 
-- Поведение:
--   - Создает новую запись победителя
--   - Выбрасывает ошибку (constraint violation), если proposal_id уже победитель
--   - awarded_share устанавливается в NULL (может быть обновлен позже)
-- 
-- Возвращает: Базовую информацию о созданном победителе
-- 
-- Использование: API POST /api/v1/winners - ручное создание победителя
-- 
-- Ошибки:
--   - pq: duplicate key value violates unique constraint "winners_proposal_id_key"
--     если предложение уже является победителем
INSERT INTO winners (
    proposal_id,
    rank,
    notes
) VALUES (
    $1, $2, $3
)
RETURNING id, proposal_id, rank, created_at;

-- ============================================================================
-- ЧТЕНИЕ (ПОЛУЧЕНИЕ ДАННЫХ)
-- ============================================================================

-- name: GetWinnerByID :one
-- Назначение: Получить запись победителя по его ID.
-- 
-- Параметры:
--   $1 (id) - Уникальный идентификатор записи в таблице winners
-- 
-- Возвращает: Полную запись победителя или sql.ErrNoRows если не найдена
-- 
-- Использование: API GET /api/v1/winners/:id
SELECT * FROM winners
WHERE id = $1;

-- name: GetWinnerByProposalID :one
-- Назначение: Получить запись победителя по ID предложения.
--             Полезно для проверки, является ли предложение уже победителем.
-- 
-- Параметры:
--   $1 (proposal_id) - ID предложения
-- 
-- Возвращает: Полную запись победителя или sql.ErrNoRows если предложение
--             не является победителем
-- 
-- Использование: Валидация перед созданием, проверка статуса предложения
SELECT * FROM winners
WHERE proposal_id = $1;

-- name: ListWinnersForLot :many
-- Назначение: Получить список всех победителей для конкретного лота.
--             Упорядочены по рангу (место) и дате создания.
-- 
-- Параметры:
--   $1 (lot_id) - ID лота
--   $2 (limit)  - Максимальное количество записей (для пагинации)
--   $3 (offset) - Смещение для пагинации (сколько записей пропустить)
-- 
-- Возвращает: Список записей победителей, отсортированных по рангу (ASC)
-- 
-- Использование: 
--   - API GET /api/v1/lots/:id/winners?limit=10&offset=0
--   - Отображение списка победителей на странице лота
-- 
-- Примечание: JOIN с proposals необходим для фильтрации по lot_id
SELECT w.id, w.proposal_id, w.rank, w.awarded_share, w.notes, w.created_at, w.updated_at FROM winners w
JOIN proposals p ON w.proposal_id = p.id
WHERE p.lot_id = $1
ORDER BY w.rank ASC, w.created_at ASC
LIMIT $2
OFFSET $3;

-- ============================================================================
-- ОБНОВЛЕНИЕ
-- ============================================================================

-- name: UpdateWinnerDetails :one
-- Назначение: Частичное обновление данных победителя (PATCH-семантика).
--             Обновляет только те поля, которые были переданы (не NULL).
-- 
-- Параметры:
--   sqlc.arg(id)            - ID записи победителя (обязательный)
--   sqlc.narg(rank)         - Новое место (опционально)
--   sqlc.narg(awarded_share) - Новая доля контракта (опционально)
--   sqlc.narg(notes)        - Новые заметки (опционально)
-- 
-- Поведение:
--   - Использует COALESCE для сохранения старых значений, если новое NULL
--   - Автоматически обновляет updated_at
--   - Если запись не найдена, возвращает sql.ErrNoRows
-- 
-- ВАЖНОЕ ОГРАНИЧЕНИЕ:
--   ⚠️  COALESCE паттерн не позволяет явно очистить поля (установить в NULL).
--   Если передать NULL для awarded_share или notes, старое значение сохранится.
--   Для очистки полей используйте явное значение (например, пустую строку для notes)
--   или создайте отдельный запрос для сброса полей.
-- 
-- Возвращает: Полную обновленную запись победителя
-- 
-- Использование: API PATCH /api/v1/winners/:id
-- 
-- Пример: Обновить только rank, оставив awarded_share и notes без изменений
UPDATE winners
SET
    rank = COALESCE(sqlc.narg(rank), rank),
    awarded_share = COALESCE(sqlc.narg(awarded_share), awarded_share),
    notes = COALESCE(sqlc.narg(notes), notes),
    updated_at = NOW()
WHERE
    id = sqlc.arg(id)
RETURNING *;

-- ============================================================================
-- УДАЛЕНИЕ
-- ============================================================================

-- name: DeleteWinnerByProposalID :exec
-- Назначение: Удалить запись победителя по ID предложения.
--             Используется при отмене статуса победителя для предложения.
-- 
-- Параметры:
--   $1 (proposal_id) - ID предложения
-- 
-- Поведение:
--   - Удаляет запись из таблицы winners
--   - Если запись не найдена, операция выполняется успешно (не ошибка)
--   - Само предложение (proposals) остается в базе
-- 
-- Возвращает: Ничего (:exec)
-- 
-- Использование: Отмена победителя, массовая очистка при реимпорте
DELETE FROM winners
WHERE proposal_id = $1;

-- name: DeleteWinnerByID :exec
-- Назначение: Удалить запись победителя по его ID.
--             Используется в REST API для точечного удаления.
-- 
-- Параметры:
--   $1 (id) - Уникальный ID записи в таблице winners
-- 
-- Поведение:
--   - Удаляет конкретную запись победителя
--   - Если запись не найдена, операция выполняется успешно (не ошибка)
-- 
-- Возвращает: Ничего (:exec)
-- 
-- Использование: API DELETE /api/v1/winners/:id
DELETE FROM winners
WHERE id = $1;

-- ============================================================================
-- СЛОЖНЫЕ ЗАПРОСЫ И ОТЧЕТЫ
-- ============================================================================

-- name: GetWinnersByTenderID :many
-- Назначение: Получить детальную информацию о всех победителях в рамках тендера.
--             Агрегирует данные из нескольких таблиц для отображения в UI.
-- 
-- Параметры:
--   $1 (tender_id) - ID тендера
-- 
-- Возвращает: Список записей с полной информацией о победителях:
--   - winner_id         - ID записи в таблице winners (для редактирования/удаления)
--   - lot_id            - ID лота, к которому относится победитель
--   - rank              - Место победителя (1, 2, 3, ...)
--   - contractor_name   - Название компании-победителя
--   - contractor_inn    - ИНН компании-победителя
--   - price             - Итоговая стоимость предложения (из proposal_summary_lines)
-- 
-- Поведение:
--   - JOIN с 4 таблицами: winners → proposals → lots → contractors
--   - LEFT JOIN с proposal_summary_lines для получения цены
--   - Фильтр по summary_key = 'total_cost_with_vat' (итоговая цена с НДС)
--   - Сортировка: сначала по lot_id, затем по рангу победителя
--   - Возвращает все записи (без пагинации)
-- 
-- Использование:
--   - API GET /api/v1/tenders/:id/winners
--   - Страница результатов тендера
--   - Экспорт данных о победителях
-- 
-- Примечание: 
--   - winner_id необходим для операций UPDATE/DELETE через API
--   - Для больших тендеров рассмотрите создание отдельного запроса с пагинацией
--   - Производительность: рекомендуются индексы на winners.proposal_id и proposals.contractor_id
--     для оптимизации JOIN операций на больших датасетах
SELECT
    w.id                          AS winner_id,
    p.lot_id                      AS lot_id,
    w.rank                        AS rank,
    c.title                       AS contractor_name,
    c.inn                         AS contractor_inn,
    psl.total_cost                AS price
FROM winners w
JOIN proposals p
  ON p.id = w.proposal_id
JOIN lots l
  ON l.id = p.lot_id
JOIN contractors c
  ON c.id = p.contractor_id
LEFT JOIN proposal_summary_lines psl
  ON psl.proposal_id = p.id
 AND psl.summary_key = 'total_cost_with_vat'
WHERE l.tender_id = $1
ORDER BY p.lot_id, w.rank ASC;

-- ============================================================================
-- ВСПОМОГАТЕЛЬНЫЕ ЗАПРОСЫ (ВАЛИДАЦИЯ)
-- ============================================================================

-- name: CheckProposalBelongsToLot :one
-- Назначение: Проверить, принадлежит ли предложение указанному лоту.
--             Используется для валидации безопасности в API.
-- 
-- Параметры:
--   $1 (proposal_id) - ID предложения
--   $2 (lot_id)      - ID лота
-- 
-- Возвращает: boolean (true если предложение принадлежит лоту, false иначе)
-- 
-- Использование:
--   - Проверка перед назначением победителя через API
--   - Валидация прав доступа (предотвращение назначения победителя
--     для предложения из другого лота)
-- 
-- Пример: Перед созданием победителя убедиться, что proposal_id
--         действительно принадлежит указанному lot_id
SELECT EXISTS(
    SELECT 1 FROM proposals 
    WHERE id = $1 AND lot_id = $2
);