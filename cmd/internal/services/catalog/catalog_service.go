// Package catalog –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç —Å–µ—Ä–≤–∏—Å–Ω—ã–π —Å–ª–æ–π –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –∫–∞—Ç–∞–ª–æ–≥–æ–º –ø–æ–∑–∏—Ü–∏–π.
//
// –≠—Ç–æ—Ç –ø–∞–∫–µ—Ç —Ä–µ–∞–ª–∏–∑—É–µ—Ç –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫—É –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–æ–º catalog_positions,
// –∫–æ—Ç–æ—Ä—ã–π —Å–ª—É–∂–∏—Ç "–∑–æ–ª–æ—Ç—ã–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–æ–º" –¥–ª—è –¥–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏–∏ –∏ –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏–∏ —Å—Ç—Ä–æ–∏—Ç–µ–ª—å–Ω—ã—Ö —Ä–∞–±–æ—Ç.
//
// # –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω–∞—è —Ä–æ–ª—å
//
// CatalogService —è–≤–ª—è–µ—Ç—Å—è —Ü–µ–Ω—Ç—Ä–∞–ª—å–Ω—ã–º –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–º RAG-–≤–æ—Ä–∫—Ñ–ª–æ—É –∏ –æ—Ç–≤–µ—á–∞–µ—Ç –∑–∞:
//
//  1. Event-Driven RAG-–∏–Ω–¥–µ–∫—Å–∞—Ü–∏—é (–ü—Ä–æ—Ü–µ—Å—Å 3–ê):
//     - –ü—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤—ã—Ö –ø–æ–∑–∏—Ü–∏–π (status='pending_indexing') –¥–ª—è Google File Search
//     - –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ –ø—Ä–æ–∏–Ω–¥–µ–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –ø–æ–∑–∏—Ü–∏–π –Ω–∞ 'active'
//
//  2. –ü–æ–∏—Å–∫ –¥—É–±–ª–∏–∫–∞—Ç–æ–≤ (–ü—Ä–æ—Ü–µ—Å—Å 3–ë):
//     - –ü–∞–≥–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –ø–æ–ª—É—á–µ–Ω–∏–µ –∞–∫—Ç–∏–≤–Ω—ã—Ö –ø–æ–∑–∏—Ü–∏–π –¥–ª—è –≤–µ–∫—Ç–æ—Ä–Ω–æ–≥–æ –ø–æ–∏—Å–∫–∞
//     - –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π –æ —Å–ª–∏—è–Ω–∏–∏ –¥—É–±–ª–∏–∫–∞—Ç–æ–≤
//
// # –ü—Ä–∏–Ω—Ü–∏–ø —Ä–∞–±–æ—Ç—ã —Å –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–º –¥–ª—è RAG
//
// –î–ª—è –≤–µ–∫—Ç–æ—Ä–Ω–æ–≥–æ –ø–æ–∏—Å–∫–∞ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –ø—Ä–∏–Ω—Ü–∏–ø "—á–∏—Å—Ç—ã—Ö –æ–ø–∏—Å–∞–Ω–∏–π":
//   - –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç –æ—Ç–¥–∞–µ—Ç—Å—è –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–º—É –æ–ø–∏—Å–∞–Ω–∏—é (—Å –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω—ã–º–∏ —Ñ–æ—Ä–º–∞–º–∏ —Å–ª–æ–≤)
//   - Fallback –Ω–∞ –ª–µ–º–º–∞—Ç–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—É—é –≤–µ—Ä—Å–∏—é –ø—Ä–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–∏ –æ–ø–∏—Å–∞–Ω–∏—è
//   - –ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ (–ª–æ—Ç, —Ç–µ–Ω–¥–µ—Ä, –ø–æ–¥—Ä—è–¥—á–∏–∫) –ù–ï –≤–∫–ª—é—á–∞—é—Ç—Å—è –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç
//
// –û–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ: Google —ç–º–±–µ–¥–¥–∏–Ω–≥–∏ –æ–±—É—á–µ–Ω—ã –Ω–∞ –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω–æ–º —è–∑—ã–∫–µ –∏ –ª—É—á—à–µ —Ä–∞–±–æ—Ç–∞—é—Ç
// —Å —Å–µ–º–∞–Ω—Ç–∏—á–µ—Å–∫–∏ —á–∏—Å—Ç—ã–º –∫–æ–Ω—Ç–µ–Ω—Ç–æ–º –±–µ–∑ –∏–∑–±—ã—Ç–æ—á–Ω—ã—Ö –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö.
//
// # –°–≤—è–∑—å —Å –¥—Ä—É–≥–∏–º–∏ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞–º–∏
//
//   - importer.TenderImportService: —Å–æ–∑–¥–∞–µ—Ç –∑–∞–ø–∏—Å–∏ —Å–æ —Å—Ç–∞—Ç—É—Å–æ–º 'pending_indexing'
//   - Python RAG-–≤–æ—Ä–∫–µ—Ä: –∏—Å–ø–æ–ª—å–∑—É–µ—Ç GET /catalog/unindexed –∏ POST /catalog/indexed
//   - Python Duplicate Finder: –∏—Å–ø–æ–ª—å–∑—É–µ—Ç GET /catalog/active –∏ POST /merges/suggest
//
// # –ò—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ —Ç–∞–±–ª–∏—Ü—ã –ë–î
//
//   - catalog_positions: –æ—Å–Ω–æ–≤–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞ —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∞ (–ø–æ–ª—è: id, standard_job_title, description, kind, status)
//   - suggested_merges: —Ç–∞–±–ª–∏—Ü–∞ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π –æ —Å–ª–∏—è–Ω–∏–∏ –¥—É–±–ª–∏–∫–∞—Ç–æ–≤
package catalog

import (
	"context"
	"fmt"
	"strings"

	"github.com/zhukovvlad/tenders-go/cmd/internal/api_models"
	db "github.com/zhukovvlad/tenders-go/cmd/internal/db/sqlc"
	"github.com/zhukovvlad/tenders-go/cmd/internal/services/apierrors"
	"github.com/zhukovvlad/tenders-go/cmd/pkg/logging"
)

// CatalogService —É–ø—Ä–∞–≤–ª—è–µ—Ç –æ–ø–µ—Ä–∞—Ü–∏—è–º–∏ —Å –∫–∞—Ç–∞–ª–æ–≥–æ–º –ø–æ–∑–∏—Ü–∏–π.
//
// –≠—Ç–æ—Ç —Å–µ—Ä–≤–∏—Å –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç –≤—ã—Å–æ–∫–æ—É—Ä–æ–≤–Ω–µ–≤—ã–µ –º–µ—Ç–æ–¥—ã –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å catalog_positions,
// —Å–∫—Ä—ã–≤–∞—è –¥–µ—Ç–∞–ª–∏ —Ä–∞–±–æ—Ç—ã —Å –ë–î –∏ —Ä–µ–∞–ª–∏–∑—É—è –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫—É –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –∏ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –¥–∞–Ω–Ω—ã—Ö.
type CatalogService struct {
	store  db.Store        // –ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ –ë–î (SQLC-—Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã)
	logger *logging.Logger // –°—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ª–æ–≥–≥–µ—Ä –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –æ–ø–µ—Ä–∞—Ü–∏–π
}

// NewCatalogService —Å–æ–∑–¥–∞–µ—Ç –Ω–æ–≤—ã–π —ç–∫–∑–µ–º–ø–ª—è—Ä CatalogService.
//
// –ü–∞—Ä–∞–º–µ—Ç—Ä—ã:
//   - store: –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å db.Store –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –æ–ø–µ—Ä–∞—Ü–∏–π —Å –ë–î
//   - logger: —ç–∫–∑–µ–º–ø–ª—è—Ä –ª–æ–≥–≥–µ—Ä–∞ –¥–ª—è –∑–∞–ø–∏—Å–∏ —Å–æ–±—ã—Ç–∏–π –∏ –æ—à–∏–±–æ–∫
//
// –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –≥–æ—Ç–æ–≤—ã–π –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é —Å–µ—Ä–≤–∏—Å –∫–∞—Ç–∞–ª–æ–≥–∞.
func NewCatalogService(store db.Store, logger *logging.Logger) *CatalogService {
	return &CatalogService{
		store:  store,
		logger: logger,
	}
}

// GetUnindexedCatalogItems —Ä–µ–∞–ª–∏–∑—É–µ—Ç GET /api/v1/catalog/unindexed.
//
// # –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ
//
// –≠—Ç–æ—Ç –º–µ—Ç–æ–¥ –æ–±—Å–ª—É–∂–∏–≤–∞–µ—Ç –ü—Ä–æ—Ü–µ—Å—Å 3–ê (Event-Driven RAG-–∏–Ω–¥–µ–∫—Å–∞—Ü–∏—è).
// –û–Ω –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç Python RAG-–≤–æ—Ä–∫–µ—Ä—É —Å–ø–∏—Å–æ–∫ –Ω–æ–≤—ã—Ö –ø–æ–∑–∏—Ü–∏–π –∫–∞—Ç–∞–ª–æ–≥–∞,
// –∫–æ—Ç–æ—Ä—ã–µ —Ç—Ä–µ–±—É—é—Ç –∏–Ω–¥–µ–∫—Å–∞—Ü–∏–∏ –≤ Google File Search Store.
//
// # Workflow –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è
//
//  1. Go Import Service —Å–æ–∑–¥–∞–µ—Ç –Ω–æ–≤—É—é –∑–∞–ø–∏—Å—å catalog_positions —Å–æ —Å—Ç–∞—Ç—É—Å–æ–º 'pending_indexing'
//  2. Go –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ñ–ª–∞–≥ new_catalog_items_pending=true –≤ –æ—Ç–≤–µ—Ç–µ –Ω–∞ POST /import-tender
//  3. Python-–ø–∞—Ä—Å–µ—Ä –≤—ã–∑—ã–≤–∞–µ—Ç Celery-–∑–∞–¥–∞—á—É –¥–ª—è –∏–Ω–¥–µ–∫—Å–∞—Ü–∏–∏
//  4. Celery-–≤–æ—Ä–∫–µ—Ä –≤—ã–∑—ã–≤–∞–µ—Ç —ç—Ç–æ—Ç endpoint –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –æ—á–µ—Ä–µ–¥–∏
//  5. –ü–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ –≤ Google, –≤–æ—Ä–∫–µ—Ä –≤—ã–∑—ã–≤–∞–µ—Ç POST /catalog/indexed
//
// # –§–æ—Ä–º–∞—Ç –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
//
// –î–ª—è –∫–∞–∂–¥–æ–π –ø–æ–∑–∏—Ü–∏–∏ —Ñ–æ—Ä–º–∏—Ä—É–µ—Ç—Å—è "—á–∏—Å—Ç–∞—è" —Å—Ç—Ä–æ–∫–∞ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞:
//   - –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç: –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ (—Å –ø–∞–¥–µ–∂–∞–º–∏ –∏ –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω—ã–º–∏ —Ñ–æ—Ä–º–∞–º–∏)
//   - Fallback: –ª–µ–º–º–∞—Ç–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è (standard_job_title)
//   - –ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ (–ª–æ—Ç/—Ç–µ–Ω–¥–µ—Ä/–ø–æ–¥—Ä—è–¥—á–∏–∫) –ù–ï –≤–∫–ª—é—á–∞—é—Ç—Å—è
//
// –û–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ: Google —ç–º–±–µ–¥–¥–∏–Ω–≥–∏ –ª—É—á—à–µ —Ä–∞–±–æ—Ç–∞—é—Ç —Å —Å–µ–º–∞–Ω—Ç–∏—á–µ—Å–∫–∏ —á–∏—Å—Ç—ã–º,
// –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω—ã–º —è–∑—ã–∫–æ–º –±–µ–∑ –∏–∑–±—ã—Ç–æ—á–Ω—ã—Ö —Ç–µ–≥–æ–≤ –∏ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö.
//
// # –ü–∞—Ä–∞–º–µ—Ç—Ä—ã
//
//   - ctx: –∫–æ–Ω—Ç–µ–∫—Å—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∑–∞–ø—Ä–æ—Å–∞
//   - limit: –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–∑–∏—Ü–∏–π –≤ –æ—Ç–≤–µ—Ç–µ (–¥–ª—è –±–∞—Ç—á–∏–Ω–≥–∞)
//
// # –í–æ–∑–≤—Ä–∞—â–∞–µ–º–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ
//
//   - []UnmatchedPositionResponse: –º–∞—Å—Å–∏–≤ –ø–æ–∑–∏—Ü–∏–π –¥–ª—è –∏–Ω–¥–µ–∫—Å–∞—Ü–∏–∏
//   - error: –æ—à–∏–±–∫–∞ –ë–î –∏–ª–∏ nil –ø—Ä–∏ —É—Å–ø–µ—Ö–µ
//
// # –í–∞–∂–Ω—ã–µ –¥–µ—Ç–∞–ª–∏
//
//   - –ü–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è DTO UnmatchedPositionResponse (–∏–∑–Ω–∞—á–∞–ª—å–Ω–æ –¥–ª—è –ü—Ä–æ—Ü–µ—Å—Å–∞ 2)
//   - PositionItemID —Å–æ–¥–µ—Ä–∂–∏—Ç catalog_id (–Ω–µ position_item.id!)
//   - –í–æ–∑–≤—Ä–∞—â–∞—é—Ç—Å—è —Ç–æ–ª—å–∫–æ –∑–∞–ø–∏—Å–∏ —Å kind='POSITION' (–∏—Å–∫–ª—é—á–∞—é—Ç—Å—è HEADER, LOT_HEADER –∏ —Ç.–¥.)
func (s *CatalogService) GetUnindexedCatalogItems(
	ctx context.Context,
	limit int32,
) ([]api_models.UnmatchedPositionResponse, error) {

	// 1. –í—ã–∑—ã–≤–∞–µ–º –Ω–∞—à SQLC-–∑–∞–ø—Ä–æ—Å
	dbRows, err := s.store.GetUnindexedCatalogItems(ctx, limit)
	if err != nil {
		s.logger.Errorf("–û—à–∏–±–∫–∞ GetUnindexedCatalogItems: %v", err)
		return nil, fmt.Errorf("–æ—à–∏–±–∫–∞ –ë–î: %w", err)
	}

	response := make([]api_models.UnmatchedPositionResponse, 0, len(dbRows))

	// 2. –§–æ—Ä–º–∏—Ä—É–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç –¥–ª—è RAG-–∏–Ω–¥–µ–∫—Å–∞
	// –ü—Ä–∏–Ω—Ü–∏–ø: –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –ü–†–û–°–¢–û–ï –æ–ø–∏—Å–∞–Ω–∏–µ, –±–µ–∑ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö
	// (Google —ç–º–±–µ–¥–¥–∏–Ω–≥–∏ –ª—É—á—à–µ —Ä–∞–±–æ—Ç–∞—é—Ç —Å –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω—ã–º —è–∑—ã–∫–æ–º)
	for _, row := range dbRows {

		// –ü—Ä–µ–¥–ø–æ—á–∏—Ç–∞–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ (—Å –ø–∞–¥–µ–∂–∞–º–∏ –∏ —Å–∫–ª–æ–Ω–µ–Ω–∏—è–º–∏)
		// Fallback –Ω–∞ –ª–µ–º–º–∞—Ç–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—É—é –≤–µ—Ä—Å–∏—é, –µ—Å–ª–∏ –æ–ø–∏—Å–∞–Ω–∏—è –Ω–µ—Ç
		var contextString string
		if row.Description.Valid && strings.TrimSpace(row.Description.String) != "" {
			contextString = strings.TrimSpace(row.Description.String)
		} else {
			contextString = row.StandardJobTitle
		}

		response = append(response, api_models.UnmatchedPositionResponse{
			// Python-–≤–æ—Ä–∫–µ—Ä—É –Ω—É–∂–µ–Ω 'catalog_id'
			PositionItemID:     row.CatalogID,
			JobTitleInProposal: row.StandardJobTitle,
			RichContextString:  contextString,
		})
	}

	s.logger.Infof("–ù–∞–π–¥–µ–Ω–æ %d –Ω–µ–∏–Ω–¥–µ–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –∑–∞–ø–∏—Å–µ–π –∫–∞—Ç–∞–ª–æ–≥–∞ –¥–ª—è RAG", len(response))
	return response, nil
}

// MarkCatalogItemsAsActive —Ä–µ–∞–ª–∏–∑—É–µ—Ç POST /api/v1/catalog/indexed.
//
// # –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ
//
// –ó–∞–≤–µ—Ä—à–∞–µ—Ç –ü—Ä–æ—Ü–µ—Å—Å 3–ê (Event-Driven RAG-–∏–Ω–¥–µ–∫—Å–∞—Ü–∏—è), —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—è —Å—Ç–∞—Ç—É—Å 'active'
// –¥–ª—è –ø–æ–∑–∏—Ü–∏–π, –∫–æ—Ç–æ—Ä—ã–µ –±—ã–ª–∏ —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω—ã –≤ Google File Search Store.
//
// # Workflow –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è
//
//  1. Python RAG-–≤–æ—Ä–∫–µ—Ä –ø–æ–ª—É—á–∞–µ—Ç –ø–æ–∑–∏—Ü–∏–∏ —á–µ—Ä–µ–∑ GET /catalog/unindexed
//  2. –ó–∞–≥—Ä—É–∂–∞–µ—Ç –∏—Ö –≤ Google File Search (—Å–æ–∑–¥–∞–µ—Ç –¥–æ–∫—É–º–µ–Ω—Ç—ã —Å —ç–º–±–µ–¥–¥–∏–Ω–≥–∞–º–∏)
//  3. –í—ã–∑—ã–≤–∞–µ—Ç —ç—Ç–æ—Ç endpoint —Å –º–∞—Å—Å–∏–≤–æ–º —É—Å–ø–µ—à–Ω–æ –ø—Ä–æ–∏–Ω–¥–µ–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö catalog_ids
//  4. Go –æ–±–Ω–æ–≤–ª—è–µ—Ç —Å—Ç–∞—Ç—É—Å: 'pending_indexing' -> 'active'
//
// –ü–æ—Å–ª–µ —ç—Ç–æ–≥–æ –ø–æ–∑–∏—Ü–∏–∏ —Å—Ç–∞–Ω–æ–≤—è—Ç—Å—è –¥–æ—Å—Ç—É–ø–Ω—ã –¥–ª—è:
//   - –ü–æ–∏—Å–∫–∞ –¥—É–±–ª–∏–∫–∞—Ç–æ–≤ (–ü—Ä–æ—Ü–µ—Å—Å 3–ë —á–µ—Ä–µ–∑ GET /catalog/active)
//   - RAG-–º–∞—Ç—á–∏–Ω–≥–∞ –Ω–æ–≤—ã—Ö –ø–æ–∑–∏—Ü–∏–π (–ü—Ä–æ—Ü–µ—Å—Å 2)
//
// # –ü–∞—Ä–∞–º–µ—Ç—Ä—ã
//
//   - ctx: –∫–æ–Ω—Ç–µ–∫—Å—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∑–∞–ø—Ä–æ—Å–∞
//   - catalogIDs: –º–∞—Å—Å–∏–≤ ID –∑–∞–ø–∏—Å–µ–π catalog_positions –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞
//
// # –í–æ–∑–≤—Ä–∞—â–∞–µ–º–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ
//
//   - error: –æ—à–∏–±–∫–∞ –ë–î –∏–ª–∏ nil –ø—Ä–∏ —É—Å–ø–µ—Ö–µ
//
// # –í–∞–∂–Ω—ã–µ –¥–µ—Ç–∞–ª–∏
//
//   - –ü—É—Å—Ç–æ–π –º–∞—Å—Å–∏–≤ catalogIDs –Ω–µ —Å—á–∏—Ç–∞–µ—Ç—Å—è –æ—à–∏–±–∫–æ–π (–ø—Ä–æ—Å—Ç–æ –ª–æ–≥–∏—Ä—É–µ—Ç—Å—è warning)
//   - –û–ø–µ—Ä–∞—Ü–∏—è –∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–∞: –ø–æ–≤—Ç–æ—Ä–Ω—ã–π –≤—ã–∑–æ–≤ —Å —Ç–µ–º–∏ –∂–µ ID –±–µ–∑–æ–ø–∞—Å–µ–Ω
//   - –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∞—Ç–æ–º–∞—Ä–Ω–æ (–≤—Å–µ ID –≤ –æ–¥–Ω–æ–π —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏)
func (s *CatalogService) MarkCatalogItemsAsActive(
	ctx context.Context,
	catalogIDs []int64,
) error {

	if len(catalogIDs) == 0 {
		s.logger.Warn("MarkCatalogItemsAsActive: –ø–æ–ª—É—á–µ–Ω –ø—É—Å—Ç–æ–π —Å–ø–∏—Å–æ–∫ ID, –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è.")
		return nil
	}

	// 1. –í—ã–∑—ã–≤–∞–µ–º –Ω–∞—à SQLC-–∑–∞–ø—Ä–æ—Å
	err := s.store.SetCatalogStatusActive(ctx, catalogIDs)

	if err != nil {
		s.logger.Errorf("–û—à–∏–±–∫–∞ MarkCatalogItemsAsActive: %v", err)
		return fmt.Errorf("–æ—à–∏–±–∫–∞ –ë–î: %w", err)
	}

	s.logger.Infof("–£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω —Å—Ç–∞—Ç—É—Å 'active' –¥–ª—è %d –∑–∞–ø–∏—Å–µ–π –∫–∞—Ç–∞–ª–æ–≥–∞", len(catalogIDs))
	return nil
}

// SuggestMerge —Ä–µ–∞–ª–∏–∑—É–µ—Ç POST /api/v1/merges/suggest.
//
// # –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ
//
// –†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ—Ç –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ –æ —Å–ª–∏—è–Ω–∏–∏ –¥—É–±–ª–∏–∫–∞—Ç–æ–≤ –ø–æ–∑–∏—Ü–∏–π –∫–∞—Ç–∞–ª–æ–≥–∞.
// –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ –ü—Ä–æ—Ü–µ—Å—Å–µ 3–ë (–ü–æ–∏—Å–∫ –¥—É–±–ª–∏–∫–∞—Ç–æ–≤) –¥–ª—è –Ω–∞–∫–æ–ø–ª–µ–Ω–∏—è –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤
// –Ω–∞ –æ–±—ä–µ–¥–∏–Ω–µ–Ω–∏–µ –ø–µ—Ä–µ–¥ —Ñ–∏–Ω–∞–ª—å–Ω—ã–º —Ä–µ—à–µ–Ω–∏–µ–º –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞.
//
// # Workflow –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è
//
//  1. Python Duplicate Finder –ø–æ–ª—É—á–∞–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã–µ –ø–æ–∑–∏—Ü–∏–∏ —á–µ—Ä–µ–∑ GET /catalog/active
//  2. –í—ã–ø–æ–ª–Ω—è–µ—Ç –≤–µ–∫—Ç–æ—Ä–Ω—ã–π –ø–æ–∏—Å–∫ –ø–æ—Ö–æ–∂–∏—Ö –ø–æ–∑–∏—Ü–∏–π –≤ Google File Search
//  3. –î–ª—è –∫–∞–∂–¥–æ–π –ø–∞—Ä—ã —Å –≤—ã—Å–æ–∫–∏–º similarity_score –≤—ã–∑—ã–≤–∞–µ—Ç —ç—Ç–æ—Ç endpoint
//  4. –ü—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è –Ω–∞–∫–∞–ø–ª–∏–≤–∞—é—Ç—Å—è –≤ —Ç–∞–±–ª–∏—Ü–µ suggested_merges
//  5. –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä –ø–æ–∑–∂–µ –ø—Ä–æ—Å–º–∞—Ç—Ä–∏–≤–∞–µ—Ç –∏—Ö —á–µ—Ä–µ–∑ UI –∏ –ø—Ä–∏–Ω–∏–º–∞–µ—Ç —Ä–µ—à–µ–Ω–∏–µ
//
// # –ü–∞—Ä–∞–º–µ—Ç—Ä—ã
//
//   - ctx: –∫–æ–Ω—Ç–µ–∫—Å—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∑–∞–ø—Ä–æ—Å–∞
//   - req: —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ —Å –ø–æ–ª—è–º–∏:
//   - MainPositionID: ID –æ—Å–Ω–æ–≤–Ω–æ–π (–∫–∞–Ω–æ–Ω–∏—á–µ—Å–∫–æ–π) –ø–æ–∑–∏—Ü–∏–∏
//   - DuplicatePositionID: ID –¥—É–±–ª–∏–∫–∞—Ç–∞
//   - SimilarityScore: –º–µ—Ç—Ä–∏–∫–∞ —Å—Ö–æ–∂–µ—Å—Ç–∏ (0.0-1.0)
//
// # –í–æ–∑–≤—Ä–∞—â–∞–µ–º–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ
//
//   - error: –æ—à–∏–±–∫–∞ –ë–î –∏–ª–∏ nil –ø—Ä–∏ —É—Å–ø–µ—Ö–µ
//
// # –í–∞–∂–Ω—ã–µ –¥–µ—Ç–∞–ª–∏
//
//   - –ó–∞—â–∏—Ç–∞ –æ—Ç self-merge: –ø–æ–∑–∏—Ü–∏—è –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å —Å–ª–∏—Ç–∞ —Å–∞–º–∞ —Å —Å–æ–±–æ–π
//   - –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è UPSERT: –ø–æ–≤—Ç–æ—Ä–Ω—ã–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è –æ–±–Ω–æ–≤–ª—è—é—Ç similarity_score
//   - –ù–µ –≤—ã–ø–æ–ª–Ω—è–µ—Ç —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–æ–µ —Å–ª–∏—è–Ω–∏–µ - —Ç–æ–ª—å–∫–æ —Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ—Ç –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ
func (s *CatalogService) SuggestMerge(
	ctx context.Context,
	req api_models.SuggestMergeRequest,
) error {

	// –ó–∞—â–∏—Ç–∞: –Ω–µ –ø—Ä–µ–¥–ª–∞–≥–∞—Ç—å —Å–ª–∏—è–Ω–∏–µ –ø–æ–∑–∏—Ü–∏–∏ —Å —Å–∞–º–æ–π —Å–æ–±–æ–π
	if req.MainPositionID == req.DuplicatePositionID {
		s.logger.Warnf("–ü–æ–ø—ã—Ç–∫–∞ –ø—Ä–µ–¥–ª–æ–∂–∏—Ç—å —Å–ª–∏—è–Ω–∏–µ –ø–æ–∑–∏—Ü–∏–∏ %d —Å —Å–∞–º–æ–π —Å–æ–±–æ–π. –ü—Ä–æ–ø—É—â–µ–Ω–æ.", req.MainPositionID)
		return nil // –ù–µ –æ—à–∏–±–∫–∞, –ø—Ä–æ—Å—Ç–æ –ø—Ä–æ–ø—É—Å–∫–∞–µ–º
	}

	// 1. –í—ã–∑—ã–≤–∞–µ–º –Ω–∞—à SQLC-–∑–∞–ø—Ä–æ—Å
	err := s.store.UpsertSuggestedMerge(ctx, db.UpsertSuggestedMergeParams{
		MainPositionID:      req.MainPositionID,
		DuplicatePositionID: req.DuplicatePositionID,
		SimilarityScore:     float32(req.SimilarityScore),
	})

	if err != nil {
		s.logger.Errorf("–û—à–∏–±–∫–∞ UpsertSuggestedMerge: %v", err)
		return fmt.Errorf("–æ—à–∏–±–∫–∞ –ë–î –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è –æ —Å–ª–∏—è–Ω–∏–∏: %w", err)
	}

	s.logger.Infof("–£—Å–ø–µ—à–Ω–æ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–æ/–æ–±–Ω–æ–≤–ª–µ–Ω–æ —Å–ª–∏—è–Ω–∏–µ: %d -> %d (Score: %.2f)",
		req.DuplicatePositionID, req.MainPositionID, req.SimilarityScore)
	return nil
}

// GetAllActiveCatalogItems —Ä–µ–∞–ª–∏–∑—É–µ—Ç GET /api/v1/catalog/active.
//
// # –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ
//
// –ü—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç –ø–∞–≥–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Å–ø–∏—Å–æ–∫ –∞–∫—Ç–∏–≤–Ω—ã—Ö –ø–æ–∑–∏—Ü–∏–π –∫–∞—Ç–∞–ª–æ–≥–∞ –¥–ª—è –ü—Ä–æ—Ü–µ—Å—Å–∞ 3–ë
// (–ü–æ–∏—Å–∫ –¥—É–±–ª–∏–∫–∞—Ç–æ–≤). –ü–æ–∑–∏—Ü–∏–∏ —Å–æ —Å—Ç–∞—Ç—É—Å–æ–º 'active' —É–∂–µ –ø—Ä–æ–∏–Ω–¥–µ–∫—Å–∏—Ä–æ–≤–∞–Ω—ã –≤
// Google File Search –∏ –≥–æ—Ç–æ–≤—ã –¥–ª—è –≤–µ–∫—Ç–æ—Ä–Ω–æ–≥–æ –ø–æ–∏—Å–∫–∞ –ø–æ—Ö–æ–∂–∏—Ö –∑–∞–ø–∏—Å–µ–π.
//
// # Workflow –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è
//
//  1. Python Duplicate Finder –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã–µ –ø–æ–∑–∏—Ü–∏–∏ –±–∞—Ç—á–∞–º–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –ø–æ 100 —à—Ç)
//  2. –î–ª—è –∫–∞–∂–¥–æ–π –ø–æ–∑–∏—Ü–∏–∏ –≤—ã–ø–æ–ª–Ω—è–µ—Ç –≤–µ–∫—Ç–æ—Ä–Ω—ã–π –ø–æ–∏—Å–∫ –≤ Google File Search
//  3. –ï—Å–ª–∏ –Ω–∞–π–¥–µ–Ω—ã –ø–æ—Ö–æ–∂–∏–µ –ø–æ–∑–∏—Ü–∏–∏ —Å –≤—ã—Å–æ–∫–∏–º similarity_score (>0.85),
//     –≤—ã–∑—ã–≤–∞–µ—Ç POST /merges/suggest –¥–ª—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω–æ–≥–æ –¥—É–±–ª–∏–∫–∞—Ç–∞
//  4. –ü–µ—Ä–µ—Ö–æ–¥–∏—Ç –∫ —Å–ª–µ–¥—É—é—â–µ–º—É –±–∞—Ç—á—É (—É–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç offset)
//
// # –§–æ—Ä–º–∞—Ç –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
//
// –ò—Å–ø–æ–ª—å–∑—É–µ—Ç –¢–£ –ñ–ï –ª–æ–≥–∏–∫—É —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞, —á—Ç–æ –∏ GetUnindexedCatalogItems:
//   - –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç: –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ (–µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω—ã–π —è–∑—ã–∫)
//   - Fallback: –ª–µ–º–º–∞—Ç–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è
//   - –ë–µ–∑ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö (–ª–æ—Ç/—Ç–µ–Ω–¥–µ—Ä/–ø–æ–¥—Ä—è–¥—á–∏–∫)
//
// –≠—Ç–æ –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç –∫–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å –º–µ–∂–¥—É:
//   - –î–∞–Ω–Ω—ã–º–∏, –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–º–∏ –≤ Google (—á–µ—Ä–µ–∑ /catalog/unindexed)
//   - –î–∞–Ω–Ω—ã–º–∏, –∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–º–∏ –¥–ª—è –ø–æ–∏—Å–∫–∞ –¥—É–±–ª–∏–∫–∞—Ç–æ–≤ (—á–µ—Ä–µ–∑ /catalog/active)
//
// # –ü–∞—Ä–∞–º–µ—Ç—Ä—ã
//
//   - ctx: –∫–æ–Ω—Ç–µ–∫—Å—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∑–∞–ø—Ä–æ—Å–∞
//   - limit: –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–ø–∏—Å–µ–π –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É (–¥–æ–ª–∂–Ω–æ –±—ã—Ç—å > 0)
//   - offset: —Å–º–µ—â–µ–Ω–∏–µ –æ—Ç –Ω–∞—á–∞–ª–∞ –≤—ã–±–æ—Ä–∫–∏ (–¥–æ–ª–∂–Ω–æ –±—ã—Ç—å >= 0)
//
// # –í–æ–∑–≤—Ä–∞—â–∞–µ–º–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ
//
//   - []UnmatchedPositionResponse: –º–∞—Å—Å–∏–≤ –∞–∫—Ç–∏–≤–Ω—ã—Ö –ø–æ–∑–∏—Ü–∏–π
//   - error: ValidationError –ø—Ä–∏ –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã—Ö –ø–∞—Ä–∞–º–µ—Ç—Ä–∞—Ö, –æ—à–∏–±–∫–∞ –ë–î –∏–ª–∏ nil –ø—Ä–∏ —É—Å–ø–µ—Ö–µ
//
// # –í–∞–∂–Ω—ã–µ –¥–µ—Ç–∞–ª–∏
//
//   - –í–∞–ª–∏–¥–∞—Ü–∏—è –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤: limit > 0, offset >= 0
//   - –ü–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è DTO UnmatchedPositionResponse
//   - PositionItemID —Å–æ–¥–µ—Ä–∂–∏—Ç catalog_id
//   - –í–æ–∑–≤—Ä–∞—â–∞—é—Ç—Å—è —Ç–æ–ª—å–∫–æ –∑–∞–ø–∏—Å–∏ —Å kind='POSITION' –∏ status='active'
//   - –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –ø–æ id –¥–ª—è –¥–µ—Ç–µ—Ä–º–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω–æ–π –ø–∞–≥–∏–Ω–∞—Ü–∏–∏
func (s *CatalogService) GetAllActiveCatalogItems(
	ctx context.Context,
	limit int32,
	offset int32,
) ([]api_models.UnmatchedPositionResponse, error) {

	// Validate parameters
	if limit <= 0 {
		s.logger.Warnf("–ü–æ–ª—É—á–µ–Ω –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π limit: %d (–¥–æ–ª–∂–µ–Ω –±—ã—Ç—å > 0)", limit)
		return nil, apierrors.NewValidationError("–ø–∞—Ä–∞–º–µ—Ç—Ä limit –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—ã–º —á–∏—Å–ª–æ–º, –ø–æ–ª—É—á–µ–Ω–æ: %d", limit)
	}
	if offset < 0 {
		s.logger.Warnf("–ü–æ–ª—É—á–µ–Ω –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π offset: %d (–¥–æ–ª–∂–µ–Ω –±—ã—Ç—å >= 0)", offset)
		return nil, apierrors.NewValidationError("–ø–∞—Ä–∞–º–µ—Ç—Ä offset –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–º, –ø–æ–ª—É—á–µ–Ω–æ: %d", offset)
	}

	// 1. –í—ã–∑—ã–≤–∞–µ–º –Ω–∞—à –æ–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–π SQLC-–∑–∞–ø—Ä–æ—Å
	dbRows, err := s.store.GetActiveCatalogItems(ctx, db.GetActiveCatalogItemsParams{
		Limit:  limit,
		Offset: offset,
	})
	if err != nil {
		s.logger.Errorf("–û—à–∏–±–∫–∞ GetActiveCatalogItems: %v", err)
		return nil, fmt.Errorf("–æ—à–∏–±–∫–∞ –ë–î: %w", err)
	}

	response := make([]api_models.UnmatchedPositionResponse, 0, len(dbRows))

	// 2. –§–æ—Ä–º–∏—Ä—É–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç (–∏—Å–ø–æ–ª—å–∑—É–µ–º —Ç—É –∂–µ –ª–æ–≥–∏–∫—É, —á—Ç–æ –∏ –≤ GetUnindexedCatalogItems)
	for _, row := range dbRows {

		var contextString string
		// –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ç—É –∂–µ –ª–æ–≥–∏–∫—É –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–∞ "–û–ø–∏—Å–∞–Ω–∏—è", —á—Ç–æ –∏ –≤ GetUnindexedCatalogItems
		if row.Description.Valid && strings.TrimSpace(row.Description.String) != "" {
			contextString = strings.TrimSpace(row.Description.String)
		} else {
			contextString = row.StandardJobTitle
		}

		response = append(response, api_models.UnmatchedPositionResponse{
			PositionItemID:     row.CatalogID, // üëà –ü–µ—Ä–µ–¥–∞–µ–º ID –∫–∞—Ç–∞–ª–æ–≥–∞
			JobTitleInProposal: row.StandardJobTitle,
			RichContextString:  contextString, // <-- –ß–∏—Å—Ç–∞—è —Å—Ç—Ä–æ–∫–∞ –¥–ª—è —á–∏—Å—Ç–æ–≥–æ –ø–æ–∏—Å–∫–∞
		})
	}

	s.logger.Infof("–ù–∞–π–¥–µ–Ω–æ %d –ê–ö–¢–ò–í–ù–´–• –∑–∞–ø–∏—Å–µ–π –∫–∞—Ç–∞–ª–æ–≥–∞ –¥–ª—è –ø–æ–∏—Å–∫–∞ –¥—É–±–ª–∏–∫–∞—Ç–æ–≤ (Limit: %d, Offset: %d)",
		len(response), limit, offset)
	return response, nil
}
