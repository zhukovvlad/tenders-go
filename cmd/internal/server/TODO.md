# Технический долг: Обработка `additional_info`

**Дата:** 02.07.2025

## Проблема

Сейчас в хендлере `listProposalsForLotHandler` (и, возможно, в других) используется `switch` для ручной обработки поля `p.AdditionalInfo`, которое приходит из базы как `interface{}`. Это обходной путь для решения проблемы `sql: Scan error ... unsupported Scan`, возникающей, когда в JSONB-колонке в базе данных находится `NULL`.

Такой подход решает проблему только на уровне симптомов, а не в корне, и загромождает хендлер логикой, которая не относится к HTTP.

## Решение

Необходимо реализовать системное решение на уровне доступа к данным:

1.  **Создать кастомный тип:** В пакете `util` создать новый тип `NullableJSONRawMessage`, который будет реализовывать интерфейсы `sql.Scanner` и `driver.Valuer`. Это "научит" Go правильно преобразовывать `NULL` из БД в `nil` в коде и обратно.

2.  **Настроить `sqlc.yaml`:** Добавить секцию `overrides`, чтобы `sqlc` автоматически использовал наш новый тип `util.NullableJSONRawMessage` для всех колонок с типом `jsonb`.

3.  **Перегенерировать код:** Выполнить `sqlc generate`.

4.  **Очистить хендлер:** После перегенерации поле `p.AdditionalInfo` в структурах, возвращаемых из БД, будет иметь корректный тип. Можно будет полностью убрать `switch` и оставить простое присваивание, что значительно упростит код хендлера.

## Ссылки

* [Документация sqlc по Overrides](https://docs.sqlc.dev/en/latest/reference/config.html#type-overrides)